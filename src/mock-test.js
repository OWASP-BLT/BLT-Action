const nock = require('nock');
const assert = require('assert');
const axios = require('axios');

const attribution = '\n\n---\n*This comment was generated by [OWASP BLT-Action](https://github.com/OWASP-BLT/BLT-Action)*';

async function assignUserToIssue(owner, repo, issueNumber, username) {
  const url = `https://api.github.com/repos/${owner}/${repo}/issues/${issueNumber}/assignees`;
  const response = await axios.post(url, { assignees: [username] });
  return response.data;
}

async function postGiphyComment(owner, repo, issueNumber, searchText, giphyApiKey) {
  const giphyResponse = await axios.get(`https://api.giphy.com/v1/gifs/search?api_key=${giphyApiKey}&q=${searchText}&limit=1`);
  const gifUrl = giphyResponse.data.data[0]?.images?.original?.url;

  if (gifUrl) {
    const url = `https://api.github.com/repos/${owner}/${repo}/issues/${issueNumber}/comments`;
    const response = await axios.post(url, { body: `![Giphy GIF](${gifUrl})` });
    return response.data;
  } else {
    throw new Error(`No GIFs found for "${searchText}".`);
  }
}

async function postTipComment(owner, repo, issueNumber, receiver, amount) {
  const sponsorUrl = `https://github.com/sponsors/${receiver}`;
  
  // Check if GitHub Sponsors is enabled
  await axios.head(sponsorUrl);
  
  const url = `https://api.github.com/repos/${owner}/${repo}/issues/${issueNumber}/comments`;
  const response = await axios.post(url, {
    body: `ðŸ’° **Tip Request from @sender to @${receiver}**\n\nAmount: **$${amount}**\n\nTo complete this tip, please visit @${receiver}'s GitHub Sponsors page and select a one-time payment:\n\nðŸ”— [Sponsor @${receiver}](${sponsorUrl})\n\n*Note: GitHub Sponsors does not support automated payments via API. Please complete the transaction manually by selecting "One-time" on the sponsor page and entering your desired amount.*`
  });
  return response.data;
}

describe('GitHub API Mock Test', () => {
  beforeEach(() => {
    nock.cleanAll();
  });

  it('should assign a user to an issue with a PR', async () => {
    const owner = 'testowner';
    const repo = 'testrepo';
    const issueNumber = 1;
    const username = 'testuser';

    const scope = nock('https://api.github.com')
      .post(`/repos/${owner}/${repo}/issues/${issueNumber}/assignees`, { assignees: [username] })
      .reply(201, { status: 'success' });

    const result = await assignUserToIssue(owner, repo, issueNumber, username);
    assert.strictEqual(result.status, 'success');

    scope.done();
  });

  it('should post a Giphy comment on an issue', async () => {
    const owner = 'testowner';
    const repo = 'testrepo';
    const issueNumber = 1;
    const searchText = 'funny cat';
    const giphyApiKey = 'testapikey';

    const giphyScope = nock('https://api.giphy.com')
      .get(`/v1/gifs/search?api_key=${giphyApiKey}&q=${searchText}&limit=1`)
      .reply(200, {
        data: [
          {
            images: {
              original: {
                url: 'https://giphy.com/gifs/moodman-dog-confused-rigley-beans-Z5xk7fGO5FjjTElnpT'
              }
            }
          }
        ]
      });

    const githubScope = nock('https://api.github.com')
      .post(`/repos/${owner}/${repo}/issues/${issueNumber}/comments`, { body: '![Giphy GIF](https://giphy.com/gifs/moodman-dog-confused-rigley-beans-Z5xk7fGO5FjjTElnpT)' })
      .reply(201, { status: 'success' });

    const result = await postGiphyComment(owner, repo, issueNumber, searchText, giphyApiKey);
    assert.strictEqual(result.status, 'success');

    giphyScope.done();
    githubScope.done();
  });

  it('should post a tip comment with GitHub Sponsors link', async () => {
    const owner = 'testowner';
    const repo = 'testrepo';
    const issueNumber = 1;
    const receiver = 'testuser';
    const amount = '10';

    // Mock the HEAD request to check if sponsors page exists
    const sponsorScope = nock('https://github.com')
      .head(`/sponsors/${receiver}`)
      .reply(200);

    const githubScope = nock('https://api.github.com')
      .post(`/repos/${owner}/${repo}/issues/${issueNumber}/comments`, (body) => {
        return body.body.includes('Tip Request') && 
               body.body.includes(`@${receiver}`) && 
               body.body.includes(`$${amount}`) &&
               body.body.includes(`https://github.com/sponsors/${receiver}`);
      })
      .reply(201, { status: 'success' });

    const result = await postTipComment(owner, repo, issueNumber, receiver, amount);
    assert.strictEqual(result.status, 'success');

    sponsorScope.done();
    githubScope.done();
  });

  it('should send kudos to BLT API when user has profile', async () => {
    const owner = 'testowner';
    const repo = 'testrepo';
    const issueNumber = 1;
    const sender = 'githubuser';
    const receiver = 'bltuser';
    const comment = 'Great work on the PR!';
    const link = `https://github.com/${owner}/${repo}/issues/${issueNumber}`;

    const bltScope = nock('https://owaspblt.org')
      .post('/teams/give-kudos/', {
        kudosReceiver: receiver,
        kudosSender: sender,
        link: link,
        comment: comment
      })
      .reply(201, { success: true, message: 'Kudos sent successfully!' });

    // Simulate the kudos sending
    await axios.post('https://owaspblt.org/teams/give-kudos/', {
      kudosReceiver: receiver,
      kudosSender: sender,
      link: link,
      comment: comment
    });

    bltScope.done();
  });

  it('should handle kudos when user does not have BLT profile', async () => {
    const owner = 'testowner';
    const repo = 'testrepo';
    const issueNumber = 1;
    const sender = 'githubuser';
    const receiver = 'newuser';
    const comment = 'Great work on the PR!';
    const link = `https://github.com/${owner}/${repo}/issues/${issueNumber}`;

    const bltScope = nock('https://owaspblt.org')
      .post('/teams/give-kudos/', {
        kudosReceiver: receiver,
        kudosSender: sender,
        link: link,
        comment: comment
      })
      .reply(404, { success: false, error: 'Receiver username not found' });

    // Simulate the kudos sending - should not throw error even if API returns 404
    try {
      await axios.post('https://owaspblt.org/teams/give-kudos/', {
        kudosReceiver: receiver,
        kudosSender: sender,
        link: link,
        comment: comment
      });
    } catch (error) {
      // This is expected for users without BLT profile
      assert.strictEqual(error.response.status, 404);
    }

    bltScope.done();
  });

  it('should include attribution in comment bodies', () => {
    const attribution = '\n\n---\n*This comment was generated by [OWASP BLT-Action](https://github.com/OWASP-BLT/BLT-Action)*';
    
    // Test various comment bodies to ensure they include the attribution
    const testComments = [
      'You have been unassigned from this issue. It\'s now open for others. You can reassign it anytime by typing /assign.',
      'You cannot be assigned to this issue because you are already assigned to the following issues without an open pull request: #1. Please submit a pull request for these issues before getting assigned to a new one.',
      'Hello @user! You\'ve been assigned to [repo issue #1](https://github.com/owner/repo/issues/1). You have 24 hours to complete a pull request.',
      'No GIFs found for "test".',
      'ðŸŽ‰ Kudos from @sender to @receiver! ðŸŽ‰\n\nawesome work',
      'âœ… Kudos tracked on BLT profile',
      'ðŸ’¡ @receiver - Create a BLT profile to track all your kudos in one place!',
      'âš ï¸ Invalid /kudos command format.\n\nUsage: `/kudos @username [optional comment]`\n\nExample: `/kudos @alice Great work on the PR!`',
      'â° This issue has been automatically unassigned from user due to 24 hours of inactivity. The issue is now available for anyone to work on again.',
      'ðŸ’° **Tip Request from @sender to @receiver**\n\nAmount: **$10**\n\nTo complete this tip, please visit @receiver\'s GitHub Sponsors page and select a one-time payment:\n\nðŸ”— [Sponsor @receiver](https://github.com/sponsors/receiver)\n\n*Note: GitHub Sponsors does not support automated payments via API. Please complete the transaction manually by selecting "One-time" on the sponsor page and entering your desired amount.*',
      'âš ï¸ Invalid /tip command format. Use: `/tip @username $amount`\n\nExample: `/tip @contributor $10`'
    ];

    // Each comment should end with the attribution
    testComments.forEach((comment, index) => {
      const commentWithAttribution = comment + attribution;
      assert.ok(
        commentWithAttribution.includes('OWASP BLT-Action'),
        `Comment ${index + 1} should include attribution`
      );
      assert.ok(
        commentWithAttribution.includes('https://github.com/OWASP-BLT/BLT-Action'),
        `Comment ${index + 1} should include repository link`
      );
    });
  });
});